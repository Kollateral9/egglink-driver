# EGGLINK Driver

Driver repository for EGGLINK (from V3).

EGGLINK's core chip is an FT4232H with a non-standard PID avoiding conflict between Eggtronic's driver and the standard FTDI one (as it happens with Zadig).

EGGLINK's PID is 0x69E0 and is the first of the eight PIDs (**from 0x69E0 to 0x69E7**) officially reserved by FTDI for Eggtronic products. The VID is the standard FTDI one (0x0403).

Before to proceed with the driver, FT4232H settings must be adjusted according EGGLINK configuration. The [**eeprom**](eeprom/) folder contains the EEPROM template to be programmed.

## Linux (tested on Debian)

### Hardware setup

If `ftdi_eeprom` command is not available, install it running:

```bash
sudo apt -y install ftdi-eeprom
```

When the system is ready, launch the [`.sh`](eeprom/wr_eeprom.sh) file to apply the [`.conf`](eeprom/egglink-v3.conf) template.

>The script may need `sudo` if either FTDI or Eggtronic udev rules are not installed.

### Driver setup

EGGLINK on Linux needs Eggtronic's udev rules installation which adds EGGLINK's PID to FTDI serial driver (`ftdi_sio`) and prevents permission issues.

Put [**90-eggtronic.rules**](linux/90-eggtronic.rules) in **/etc/udev/rules.d** and reload udev rules (`sudo udevadm control --reload-rules && sudo udevadm trigger`) before to attach the adapter.

#### Known issues

According [FTDI documentation](https://ftdichip.com/faq/how-do-i-add-a-custom-pid-to-the-ftdi_sio-linux-com-port-driver/), only one custom PID at a time can be added to `ftdi_sio` and should be used only for development purposes. The adopted approach is therefore not so clean and doesn't allow users to add a custom PID to `ftdi_sio`.

Developing a real Linux driver would solve the above limitations.

## Windows

### Hardware setup

Load [`.xml`](eeprom/egglink-v3.xml) template in [**FT_Prog**](https://ftdichip.com/utilities/) and program the target.

>After the flashing, FT_Prog won't recognize the chip anymore. In order to make FT_Prog able to detect the target again, install the default FTDI driver on the port 0 of the device.

### Driver structure

The driver package contains [`FTDI CDM drivers`](https://ftdichip.com/drivers/) (both VCP and D2XX) and WinUSB driver (originally generated using Zadig) modified for EGGLINK.

FT4232H interfaces are used and configured as follows:

0. JTAG adapter (WinUSB)
1. Serial device programmer (WinUSB)
2. UART serial port (VCP)
3. Spare serial port (VCP)

The driver "packing framework" has been generated by `Driver Install Creator Wizard` provided by [`libusbK`](https://sourceforge.net/projects/libusbk/) utility.  
The framework automatically generates a self-singed one-file driver installer.

### Development

To generate the driver installer `InstallDriver.exe` run:

```bat
cd windows
.\re-pack-files.cmd
```

Installer's metadata (icon, info strings, etc.) can be customized before generation modifying the [`.sfx file`](windows/7ZDP_LZMA.sfx) through a tool like [`Resource Hacker`](https://www.angusj.com/resourcehacker/).

Further details in [Instructions.txt](windows/Instructions.txt).

#### Tools

By default the only way to manage drivers on Windows is the `Device Manager`. A simpler suggested alternative handling only drivers and not connected devices is [`DriverStoreExplorer`](https://github.com/lostindark/DriverStoreExplorer).
